# This CI builder performs various tests to ensure the template works
# using different configurations.
#
# To compile your own thesis, take a look at the
# .gitlab-ci-simple.yml included in this repository.
#
# Unfortunately the project folder will accumulate lots of temporary
# files. In addition, minted requires some tuning to support different
# output directories.

# due to https://docs.docker.com/docker-hub/download-rate-limit/
# the texlive image is hosted @ https://gitlab.utu.fi/tech/soft/thesis-builder

image: registry.gitlab.utu.fi/tech/soft/thesis-builder:latest

stages:
 - prepare
 - build
 - test
 - deploy

prepare_tests:
  stage: prepare
  script:
    - cd latex
    - cp utuftthesis.cls ../tests/utuftthesis.cls
    - "sed 's/version=final/version=draft/g' thesis.tex > thesis2.tex"
  artifacts:
    paths:
      - latex/thesis2.tex
      - tests/utuftthesis.cls

draft_builder:
  stage: build
  script:
    - cd latex
    - "latexmk -pdf --shell-escape thesis2.tex"
    - cp thesis2.pdf pdflatex.pdf
    - "latexmk -CA thesis2.tex"
    - "latexmk -xelatex --shell-escape thesis2.tex"
    - cp thesis2.pdf xelatex.pdf
  artifacts:
    paths:
      - latex/pdflatex.pdf
      - latex/xelatex.pdf

draft_validator:
  stage: test
  script:
    - "pdfinfo latex/pdflatex.pdf |grep '^Pages: *16$'"
    - "pdfinfo latex/xelatex.pdf |grep '^Pages: *16$'"

pdfa_builder:
  stage: build
  script:
    - cd latex
    - "latexmk -pdf --shell-escape thesis.tex"
    - cp thesis.pdf pdflatex-pdfa.pdf
    - "latexmk -CA thesis.tex"
    - "latexmk -xelatex --shell-escape thesis.tex"
    - cp thesis.pdf xelatex-pdfa.pdf
  artifacts:
    paths:
      - latex/thesis.pdf
      - latex/pdflatex-pdfa.pdf
      - latex/xelatex-pdfa.pdf

pdfa_validator:
  stage: test
  script:
    - "pdfa-validate latex/pdflatex-pdfa.pdf|grep '^PASS'"
    - "pdfa-validate latex/xelatex-pdfa.pdf|grep '^PASS'"

xelatex_builder:
  stage: build
  script:
    - cd tests
    - "for i in *.tex; do latexmk -xelatex -output-directory=xelatex/ $i; done"
  artifacts:
    paths:
      - tests/xelatex/test-app1.pdf
      - tests/xelatex/test-app2.pdf
      - tests/xelatex/test-app3.pdf
      - tests/xelatex/test-app4.pdf
      - tests/xelatex/test-app5.pdf
      - tests/xelatex/test-bilingual.pdf
      - tests/xelatex/test-english.pdf
      - tests/xelatex/test-finnish.pdf
      - tests/xelatex/test-hyperref.pdf

      
xelatex_content_validator:
  stage: test
  script:
    - cd tests/xelatex
    - "for i in *.pdf; do pdftotext $i; done"
    - "grep '2 s., 5 liites.' test-app1.txt"
    - "grep '2 s., 3 liites.' test-app2.txt"
    - "grep '2 s., 1 liites.' test-app3.txt"
    - "grep 'TkK-tutkielma, 2 s.$' test-app4.txt"
    - "grep 'TkK-tutkielma, 3 s.$' test-app5.txt"
    - "grep 'TURUN YLIOPISTO' test-finnish.txt"
    - "grep 'TURUN YLIOPISTO' test-bilingual.txt"
    - "grep 'UNIVERSITY OF TURKU' test-bilingual.txt"
    - "grep 'UNIVERSITY OF TURKU' test-english.txt"
    - "pdfinfo test-hyperref.pdf |grep 'LaTeX with hyperref'"

pdflatex_builder:
  stage: build
  script:
    - cd tests
    - "for i in *.tex; do latexmk -pdf -output-directory=pdflatex/ $i; done"
  artifacts:
    paths:
      - tests/pdflatex/test-app1.pdf
      - tests/pdflatex/test-app2.pdf
      - tests/pdflatex/test-app3.pdf
      - tests/pdflatex/test-app4.pdf
      - tests/pdflatex/test-app5.pdf
      - tests/pdflatex/test-bilingual.pdf
      - tests/pdflatex/test-english.pdf
      - tests/pdflatex/test-finnish.pdf
      - tests/pdflatex/test-hyperref.pdf

pdflatex_content_validator:
  stage: test
  script:
    - cd tests/pdflatex
    - "for i in *.pdf; do pdftotext $i; done"
    - "grep '2 s., 5 liites.' test-app1.txt"
    - "grep '2 s., 3 liites.' test-app2.txt"
    - "grep '2 s., 1 liites.' test-app3.txt"
    - "grep 'TkK-tutkielma, 2 s.$' test-app4.txt"
    - "grep 'TkK-tutkielma, 3 s.$' test-app5.txt"
    - "grep 'TURUN YLIOPISTO' test-finnish.txt"
    - "grep 'TURUN YLIOPISTO' test-bilingual.txt"
    - "grep 'UNIVERSITY OF TURKU' test-bilingual.txt"
    - "grep 'UNIVERSITY OF TURKU' test-english.txt"
    - "pdfinfo test-hyperref.pdf |grep 'LaTeX with hyperref'"

pages:
  stage: deploy
  script:
    - cp latex/thesis.pdf .
    - wget https://tech.utugit.fi/soft/tools/sitegen/sitegen.jar -O sitegen.jar
    - java -jar sitegen.jar -pdfjs
  only:
    - master
  artifacts:
    paths:
      - public/
